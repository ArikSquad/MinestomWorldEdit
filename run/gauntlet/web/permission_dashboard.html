<html>
    <head>
        <link rel="stylesheet" type="text/css" href="style.css">
    </head>
    <body id="body">
        {{{BODY}}}
        <div class="page">
            <h2 id="title">Permissions Dashboard - Authorized Session: {{{PLAYERNAME}}}@{{{SERVER}}} - 5s</h2>
            <div class="dashboard">
                <div class="controls">
                    <a class="control-button" href="#permissions" onclick="clickPermissions()"><b>Permissions</b></a>
                    <a class="control-button" href="#groups" onclick="clickGroups()"><b>Groups</b></a>
                    <a class="control-button" href="#users" onclick="clickUsers()"><b>Users</b></a>
                    <div class="control-lower">
                        <button class="control-button" onclick="sendUpdate()">Update</button>
                    </div>
                </div>
                <div class="divider"></div>
                <div class="main">
                    <div id="permissions">
                        <div class="divider-small"></div>
                        <div class="permission-container" id="permission-container">
                            ERROR
                        </div>
                        <div class="divider-small"></div>
                    </div>
                    <div id="groups">
                        <div class="divider-small"></div>
                        <div class="group-list-container">
                            <div class="group-list-header">
                                Groups
                                <input class="text-input" placeholder="Search groups" />
                            </div>
                            <div id="group-list-list" class="group-list-list">
                            </div>
                        </div>
                        <div id="group-edit-container" style="display: none;" class="group-edit-container">
                            <div class="group-edit-attributes">
                                <div class="group-edit-header">
                                    <h2 id="group-edit-title">Attributes</h2>
                                </div>
                                <div class="visible-horz-divider"></div>
                                <div class="group-edit-attributelist">
                                    <div id="groupattribute:name" class="group-attributelist-element">Name: <input class="text-input" placeholder="Name"/></div>
                                    <div id="groupattribute:priority" class="group-attributelist-element">Priority: <input class="text-input" placeholder="0"/></div>
                                    <div id="groupattribute:parent" class="group-attributelist-element">Parent: <input class="text-input" placeholder="No Parent"/></div>
                                    <div id="groupattribute:chatprefix" class="group-attributelist-element">Chat Prefix: <input class="text-input" placeholder="No Chat Prefix"/></div>
                                    <div id="groupattribute:tabprefix" class="group-attributelist-element">Tab Prefix: <input class="text-input" placeholder="No Tab Prefix"/></div>
                                </div>
                            </div>
                            <div class="group-edit-permissions">
                                <h2>Permissions</h2>
                                <div class="visible-horz-divider"></div>
                                <div class="permission-container" id="permission-container-groups">

                                </div>
                            </div>
                        </div>
                        <div class="divider-small"></div>
                    </div>
                    <div id="users">Users</div>
                </div>
            </div>
        </div>
    </body>

    <script id="template" type="text/template">
        <div class="permission-section" id="permissions-section-{num}">
            <div class="permission-header">{header}</div>
            <div class="permission-list" id="permissions-list-{num}">
            </div>
        </div>
    </script>

    <script>
        var perms = [
            "gauntlet.test.permissions",
            "gauntlet.test.other",
            "gauntlet.test.other2",
            "otherroot.othervalue",
        ]
        var groupPermissionsAll = {
            "a": {
                "attributes": {
                    "name": "Group A",
                    "priority": "0",
                    "parent": "",
                    "chatprefix": "[A] ",
                    "tabprefix": ""
                },
                "permissions": {}
            },
            "b": {
                "attributes": {
                    "name": "Group B",
                    "priority": "1",
                    "parent": "A",
                    "chatprefix": "[B] ",
                    "tabprefix": ""
                },
                "permissions": {}
            },
            "c": {
                "attributes": {
                    "name": "Group C",
                    "priority": "2",
                    "parent": "C",
                    "chatprefix": "[C] ",
                    "tabprefix": ""
                },
                "permissions": {}
            }
        }
        let body = document.getElementById("body");
        body.innerHTML = body.innerHTML.replace("{{{BODY}}}", "<input type=\"hidden\" id=\"csrf\" value=\"examplecsrf\" />");
        body.innerHTML = body.innerHTML.replace("{{{PLAYERNAME}}}", "DefaultUser");
        body.innerHTML = body.innerHTML.replace("{{{SERVER}}}", "DefaultServer");

        window.location = "permission_dashboard.html#groups";
    </script>

    <script>
        var perms = [{{{PERMS}}}];
        var groupPermissionsAll = {{{GROUPS}}};
    </script>

    <script>
        var template = document.getElementById("template").innerHTML;
        
        function isEmpty(obj) {
            for(var key in obj) {
                if(obj.hasOwnProperty(key))
                    return false;
            }
            return true;
        }

        permMap = {};
        for(let perm of perms) {
            let split = perm.split(".");
            let superMap = permMap;
            for(let line of split) {
                if(superMap[line] == null) {
                    superMap[line] = {};
                }
                superMap = superMap[line];
            }
        }

        function renameRecursively(map, oldName, newName) {
            var mapNew = {}
            for(var key in map) {
                if(key == oldName) {
                    mapNew[newName] = map[key];
                } else {
                    mapNew[key] = map[key];
                }
            }
            return mapNew;
        }

        var currentSelection = "root";
        var generateAdd = true;
        var allowRename = true;
        var nodeCreateCallback = undefined;
        var customDeleteCallback = undefined;

        function clickPermissions() {
            generateAdd = true;
            allowRename = true;
            nodeCreateCallback = undefined;
            customDeleteCallback = undefined;
            generateRoot(document.getElementById("permission-container"), currentSelection);
        }

        
        var groupPermissions = undefined;
        var groupPermissionsUUID = undefined;

        updateGroupSelectors();

        function attributeListUpdate(evt) {
            if(groupPermissions === undefined) {
                return;
            }

            let attributeName = evt.target.parentNode.id.replace("groupattribute:","");
            groupPermissions["attributes"][attributeName] = evt.target.value;

            updateGroupSelectors();
        }

        function uuidv4() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        function updateGroupSelectors() {
            let list = document.getElementById("group-list-list");

            let groupAdd = document.getElementById("group-list-add");
            if(groupAdd == undefined) {
                groupAdd = document.createElement("button");
                groupAdd.id = "group-list-add";
                groupAdd.innerHTML = "Add";
                groupAdd.addEventListener("click", (evt) => {
                    groupPermissions = {
                        "attributes": {
                            "name": "New Group",
                            "priority": "0",
                            "parent": "",
                            "chatprefix": "",
                            "tabprefix": ""
                        },
                        "permissions": {}
                    }

                    groupPermissionsUUID = uuidv4();
                    groupPermissionsAll[groupPermissionsUUID] = groupPermissions;

                    clickGroups();
                    updateGroupSelectors();

                    for(let element of document.getElementsByClassName("group-list-element")) {
                        element.removeEventListener("click", groupListEvtClick);
                        element.addEventListener("click", groupListEvtClick);
                    }
                })
                list.appendChild(groupAdd);
            }

            for(let groupUuid in groupPermissionsAll) {
                let existing = document.getElementById("group:"+groupUuid);
                if(existing != undefined) {
                    let text = document.createElement("a");
                    text.innerHTML = groupPermissionsAll[groupUuid]["attributes"]["name"];

                    existing.removeChild(existing.children[0]);
                    existing.prepend(text);
                } else {
                    let element = document.createElement("button");
                    element.id = "group:"+groupUuid;
                    element.classList.add("group-list-element");

                    let text = document.createElement("a");
                    text.innerHTML = groupPermissionsAll[groupUuid]["attributes"]["name"];
                    element.prepend(text);

                    let deleteElement = document.createElement("button");
                    deleteElement.classList.add("group-list-element-delete");
                    deleteElement.innerHTML =  "X";

                    deleteElement.addEventListener("click", (evt) => {
                        let groupName = evt.target.parentNode.id.replace("group:", "");

                        if(groupPermissionsAll[groupName] == groupPermissions) {
                            groupPermissions = undefined;
                            clickGroups();
                        }

                        delete groupPermissionsAll[groupName];
                        evt.target.parentNode.remove();
                    });

                    element.appendChild(deleteElement);

                    list.insertBefore(element, groupAdd);
                }
            }
        }

        function clickGroups() {
            if(groupPermissions === undefined) {
                document.getElementById("group-edit-container").style = "display: none";
                return;
            }
            document.getElementById("group-edit-container").style = "";

            document.getElementById("group-edit-title").innerHTML = "Attributes - " + groupPermissionsUUID;

            for(let element of document.getElementsByClassName("group-attributelist-element")) {
                let attributeName = element.id.replace("groupattribute:","");
                if(attributeName in groupPermissions["attributes"]) {
                    element.children[0].value = groupPermissions["attributes"][attributeName];
                }

                element.removeEventListener("focusout", attributeListUpdate);
                element.addEventListener("focusout", attributeListUpdate);
            }

            generateAdd = false;
            allowRename = false;

            nodeCreateCallback = function(node) {
                node.style = "";
                node.classList.remove("permission-button-bordered");

                let isSelected = undefined;
                let hasSubSelected = false;
                let hasSuperSelected = undefined;
                let permGroup = groupPermissions["permissions"];

                for(let perm of node.id.replace("root.", "").split(".")) {
                    if(isSelected != undefined) {
                        hasSuperSelected = isSelected;
                        break;
                    }

                    if(perm in permGroup) {
                        if(permGroup[perm] == true) {
                            isSelected = true;
                        } else if(permGroup[perm] == false) {
                            isSelected = false;
                        }

                        hasSubSelected = true;

                        permGroup = permGroup[perm];
                    } else {
                        isSelected = undefined;
                        hasSubSelected = false;
                    }
                }
                
                if(hasSuperSelected) {
                    node.children[1].innerHTML = "-"
                    node.children[1].style = "color: gray"

                    node.classList.add("permission-button-bordered");
                    node.style = "border-width: 2px; border-style: solid; border-color: green";
                } else if(isSelected === undefined) {
                    node.children[1].innerHTML = "-"
                    node.children[1].style = "color: gray"
                    if(hasSubSelected) {
                        node.classList.add("permission-button-bordered");
                        node.style = "border-width: 2px; border-style: solid; border-color: yellow";
                    }
                } else if(isSelected == true) {
                    node.classList.add("permission-button-bordered");
                    node.style = "border-width: 2px; border-style: solid; border-color: green";

                    node.children[1].innerHTML = "&#10004;"
                    node.children[1].style = "color: green;"
                } else if(isSelected == false) {
                    node.classList.add("permission-button-bordered");
                    node.style = "border-width: 2px; border-style: solid; border-color: red";

                    node.children[1].innerHTML = "X"
                    node.children[1].style = "color: red;"
                } 
            };

            customDeleteCallback = function(evt) {
                let split = evt.target.parentNode.id.replace("root.", "").split(".");

                let permGroup = groupPermissions["permissions"];

                let created = false;

                for(let i=0; i<split.length-1; i++) {
                    let perm = split[i];

                    if(permGroup[perm] instanceof Object && perm in permGroup) {
                        permGroup = permGroup[perm];
                    } else {
                        created = true;
                        permGroup[perm] = {};
                        permGroup = permGroup[perm];
                    }
                }

                let last = split[split.length-1];

                if(created) {
                    permGroup[last] = true;
                    for(let element of document.getElementsByClassName("permission-button")) {
                        if(nodeCreateCallback != undefined) {
                            nodeCreateCallback(element);
                        }
                    }
                    return;
                }

                if(last in permGroup) {
                    if(permGroup[last] == true) {
                        permGroup[last] = false;
                    } else {
                        delete permGroup[last];

                        let size = split.length-1;
                        while(true) {
                            let permGroup = groupPermissions["permissions"];
                            for(let i=0; i<split.length; i++) {
                                let perm = split[i];

                                if(perm in permGroup) {
                                    if(isEmpty(permGroup[perm])) {
                                        delete permGroup[perm];
                                        size = i;
                                        break;
                                    } else {
                                        permGroup = permGroup[perm];
                                    }
                                }

                                if(size == i) {
                                    for(let element of document.getElementsByClassName("permission-button")) {
                                        if(nodeCreateCallback != undefined) {
                                            nodeCreateCallback(element);
                                        }
                                    }   
                                    return;
                                }
                            }
                        }
                    }
                } else {
                    permGroup[last] = true;
                }

                for(let element of document.getElementsByClassName("permission-button")) {
                    if(nodeCreateCallback != undefined) {
                        nodeCreateCallback(element);
                    }
                }
            };

            generateRoot(document.getElementById("permission-container-groups"), currentSelection);
        }

        var currentContainer;

        function generateRoot(container, selection) {
            for(let element of document.getElementsByClassName("permission-container")) {
                element.innerHTML = "";
            }

            currentContainer = container;

            generate(currentContainer, permMap, selection, "");
            addListeners();
        }

        function addListeners() {
            for(let element of document.getElementsByClassName("permission-button")) {
                element.removeEventListener("click", permButtonClickEvt);
                element.addEventListener("click", permButtonClickEvt);
            }
            for(let element of document.getElementsByClassName("permission-button-add")) {
                element.removeEventListener("click", permButtonAddClickEvt);
                element.addEventListener("click", permButtonAddClickEvt);
            }
            for(let element of document.getElementsByClassName("permission-button-delete")) {
                if(customDeleteCallback === undefined) {
                    element.removeEventListener("click", permButtonDeleteClickEvt);
                    element.addEventListener("click", permButtonDeleteClickEvt);
                } else {
                    element.removeEventListener("click", customDeleteCallback);
                    element.addEventListener("click", customDeleteCallback);
                }
            }
            for(let element of document.getElementsByClassName("permission-button-textfield")) {
                element.removeEventListener("focusin", permTextFieldEvtClick);
                element.addEventListener("focusin", permTextFieldEvtClick);

                element.removeEventListener("input", permTextFieldEvtInput);
                element.addEventListener("input", permTextFieldEvtInput);
                
                element.removeEventListener("keypress", permTextFieldEvtKeypress);
                element.addEventListener("keypress", permTextFieldEvtKeypress);
                
                element.removeEventListener("focusout", permTextFieldEvtBlur);
                element.addEventListener("focusout", permTextFieldEvtBlur);
            }
        }

        function permTextFieldEvtClick(evt) {
            if(!evt.target.parentNode.classList.contains("permission-button-texteditable")) {
                evt.preventDefault();
                evt.stopPropagation();
                evt.target.parentNode.click();
                evt.target.blur();
            }
        }
        
        function permButtonDeleteClickEvt(evt) {
            let split = evt.target.parentNode.id.split(".");

            if(split.length == 2) {
                delete permMap[split[split.length-1]];
            } else {
                let map = {"root": permMap};
                for(let i=0; i<split.length-1; i++) {
                    map = map[split[i]];
                }

                delete map[split[split.length-1]];
            }

            if(currentSelection.includes(evt.target.parentNode.id)) {
                split.pop();
                setCurrentSelection(split.join("."));
            }

            evt.target.parentNode.remove();
        }

        function permTextFieldEvtBlur(evt) {
            let split = evt.target.parentNode.id.split(".");

            if(split[split.length-1] === evt.target.value) return;

            if(split.length == 2) {
                permMap = renameRecursively(permMap, split[split.length-1], evt.target.value);
            } else {
                let map = {"root": permMap};
                for(let i=0; i<split.length-2; i++) {
                    map = map[split[i]];
                }

                map[split[split.length-2]] = renameRecursively(map[split[split.length-2]], split[split.length-1], evt.target.value);
            }

            evt.target.parentNode.id = evt.target.parentNode.id.replace(RegExp(split[split.length-1]+"$", "g"), evt.target.value);

            let currentSplit = currentSelection.split(".");
            if(currentSplit[split.length-1] === split[split.length-1]) {
                currentSplit[split.length-1] = evt.target.value;
            }

            setCurrentSelection(currentSplit.join("."), currentSplit.length - split.length);
        }

        function permTextFieldEvtKeypress(evt) {
            if (evt.which === 13) {
                evt.preventDefault();
                evt.target.blur();
            }
            if(!((evt.which >= 48 && evt.which <= 57) || (evt.which >= 65 && evt.which <= 90) || (evt.which >= 97 && evt.which <= 122))) {
                evt.preventDefault();
            }
        }

        function permTextFieldEvtInput(evt) {
            evt.target.style.width = (evt.target.value.length+1) + "ch";
        }

        function permButtonAddClickEvt(evt) {
            let add = evt.target.id.replace("add:", "");

            let split = add.split(".");

            let map = {"root": permMap};
            for(let i=0; i<split.length; i++) {
                map = map[split[i]];
            }

            let newName = "new";
            let i = 0;
            while(document.getElementById(add+"."+newName) != undefined) {
                newName = "new" + (++i);
            }

            map[newName] = {};
            
            let el = createPermissionButton(add, newName);

            evt.target.parentNode.parentNode.insertBefore(el, evt.target.parentNode);
            
            addListeners();
        }

        function setCurrentSelection(selection, extraDelete) {
            currentSelection = selection;

            let children = currentContainer.children.length;

            toDelete = children - currentSelection.split(".").length + 1;

            if(extraDelete == undefined) extraDelete = 0;
            toDelete += extraDelete;

            for(let i=0; i<toDelete; i++) {
                currentContainer.children[currentContainer.children.length-1].remove();
            }

            let split = currentSelection.split(".");

            let map = {"root": permMap};
            let fullSelection = "";
            for(let i=0; i<split.length-extraDelete; i++) {
                let perm = split[i];
                map = map[perm];

                if(i < split.length-1-extraDelete) {
                    fullSelection += perm;
                }
                if(i < split.length - 2-extraDelete) {
                    fullSelection += ".";
                }
            }

            if(!generateAdd && isEmpty(map)) {
                return;
            }

            var name = split[split.length-1-extraDelete];

            let map2 = {};
            map2[name] = map;

            generate(currentContainer, map2, name, fullSelection);
            addListeners();
        }

        function permButtonClickEvt(evt) {
            if(evt.target.id === "") return;

            setCurrentSelection(evt.target.id);

            for(let child of evt.target.parentNode.children) {
                child.classList.remove("permission-button-active");
                child.classList.remove("permission-button-texteditable");
            }

            if(generateAdd || currentContainer.children[currentContainer.children.length-1] != evt.target.parentNode.parentNode) {
                evt.target.classList.add("permission-button-active");
            }
            if(allowRename) {
                evt.target.classList.add("permission-button-texteditable");
            }
        }

        function createPermissionButton(prior, name) {
            let el = document.createElement("button");
            el.classList.toggle("permission-button");
            el.id = prior + "." + name;
            el.innerHTML = "<input class=\"permission-button-textfield\" value="+name+">";
            el.innerHTML += "<div class=\"permission-button-delete\">X</div>";
            el.children[0].style.width = (name.length+1) + "ch";

            if(nodeCreateCallback != undefined) {
                nodeCreateCallback(el);
            }

            return el;
        }

        function generate(container, permMap, selection, fullSelectionF) {
            let split = selection.split(".");

            let fullSelection = fullSelectionF;
            if(fullSelection.length > 0) {
                fullSelection += ".";
            }
            fullSelection += split[0];
            
            let map = permMap;
            if(split[0] != "root") {
                map = map[split[0]];
            }

            if(!generateAdd && isEmpty(map)) {
                return;
            }

            addPermissionSection(container, split[0], "permissions");
            
            let index = container.children.length;
            let permList = document.getElementById("permissions-list-"+index);
            for(let perm in map) {
                let el = createPermissionButton(fullSelection, perm);

                if(split.length >= 2 && perm === split[1]) {
                    if(generateAdd || !isEmpty(map[perm])) el.classList.add("permission-button-active");
                    if(allowRename) {
                        el.classList.add("permission-button-texteditable");
                    }
                }

                permList.appendChild(el);
            }

            if(generateAdd) {
                let el = document.createElement("button");
                el.classList.toggle("permission-button-add");
                el.innerHTML = "Add";
                el.id = "add:"+fullSelection;

                let elDiv = document.createElement("div");
                elDiv.classList.add("permission-button-add-container");
                elDiv.appendChild(el);
                permList.appendChild(elDiv);
            }

            if(split.length >= 2) {
                let remaining = "";

                for(let i=1; i<split.length; i++) {
                    remaining += split[i];
                    if(i != split.length-1) remaining += ".";
                }

                generate(container, map, remaining, fullSelection);
            }
        }

        function addPermissionSection(container, header, listname) {
            let children = container.children.length;

            let el = createElementFromHTML(template
                .replaceAll("{num}", children+1)
                .replaceAll("{header}", header)
                .replaceAll("{listname}", listname));

            container.appendChild(el);
        }

        function createElementFromHTML(htmlString) {
            var div = document.createElement('div');
            div.innerHTML = htmlString.trim();
            return div.firstChild; 
        }

        for(let element of document.getElementsByClassName("group-list-element")) {
            element.removeEventListener("click", groupListEvtClick);
            element.addEventListener("click", groupListEvtClick);
        }

        function groupListEvtClick(evt) {
            groupPermissionsUUID = evt.target.id.replace("group:", "");
            groupPermissions = groupPermissionsAll[groupPermissionsUUID];
            clickGroups();  
        }

        // Example POST method implementation:
        function postData(url = '', data = {}, func = function(){}) {
            // Default options are marked with *
            fetch(url, {
                method: 'POST', // *GET, POST, PUT, DELETE, etc.
                mode: 'cors', // no-cors, *cors, same-origin
                cache: 'no-cache', // *default, no-cache, reload, force-cache, only-if-cached
                credentials: 'same-origin', // include, *same-origin, omit
                headers: {
                'Content-Type': 'application/json',
                'csrf': document.getElementById('csrf').value
                },
                redirect: 'follow', // manual, *follow, error
                referrerPolicy: 'no-referrer', // no-referrer, *no-referrer-when-downgrade, origin, origin-when-cross-origin, same-origin, strict-origin, strict-origin-when-cross-origin, unsafe-url
                body: JSON.stringify(data) // body data type must match "Content-Type" header
            }).then(response => response.text()).then(data => func(data));
        }

        function sendUpdate() {
            postData("update", {"perms": permMap, "groups": groupPermissionsAll});
        }

        var csrfRefreshTimer = 5;

        setTimeout(refreshCsrf, csrfRefreshTimer*1000);
        setInterval(updateTitle, 1000);

        function refreshCsrf() {
            postData("heartbeat", {}, function(response) {
                if(response != "success") {
                    csrfRefreshTimer = -1;
                } else {
                    csrfRefreshTimer = 30;
                    setTimeout(refreshCsrf, csrfRefreshTimer*1000);
                }
            });
        }

        function updateTitle() {
            if(csrfRefreshTimer < 0) {
                var newTitle = "Permissions Dashboard - UNAUTHOROIZED, CHANGES WILL NOT SAVE"
            } else {
                csrfRefreshTimer--;
                var newTitle =  "Permissions Dashboard - Authorized Session: {{{PLAYERNAME}}}@{{{SERVER}}} - "+csrfRefreshTimer+"s";
            }
            if(document.getElementById("title").innerHTML != newTitle) {
                document.getElementById("title").innerHTML = newTitle;
            }
        }
    </script>
</html>